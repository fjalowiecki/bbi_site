{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Add project{% endblock %}
{% block content %}
<main>
  <div class="flex justify-center">
    <div class="w-full max-w-2xl py-6">
      <form method="POST" enctype="multipart/form-data" action="{% url 'bbi_app:add_project' %}" class="space-y-6">
        {% csrf_token %}
        <div class="flex flex-col">
          <label for="{{ form.title.id_for_label }}" class="mb-2">Tytuł działania:</label>
          {{ form.title|add_class:"border-2 border-black p-2" }}
          {{ form.title.errors|add_class:"text-red-500 text-sm" }}
          <span class="mt-2 text-right font-extralight text-xs">Maksymalnie 40 znaków</span>
        </div>
        <div class="flex flex-col">
          <label for="{{ form.description.id_for_label }}" class="mt-2">Opis działania:</label>
          <p class="mb-1 mt-2 text-sm font-extralight">Postarajcie się zawrzeć w opisie takie informacje jak:</p>
          <p class="text-sm font-extralight mb-2">
            - opis tego co zrobiliście<br>
            - liczba osób zaangażowanych w realizację działania<br>
            - sposób zaangażowania w realizację działania<br></p>
          {{ form.description|add_class:"border-2 border-black p-2" }}
          {{ form.description.errors|add_class:"text-red-500 text-sm" }}
          <span class="mt-2 text-right font-extralight text-xs">Maksymalnie 500 znaków</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="flex flex-col">
            <label for="{{ form.location.id_for_label }}" class="mb-2 font-normal">Lokalizacja:</label>
            {{ form.location|add_class:"border-2 border-black p-2" }}
            {{ form.location.errors|add_class:"text-red-500 text-sm" }}
          </div>
          <div class="flex flex-col">
            <label for="{{ form.year_of_completion.id_for_label }}" class="mb-2 font-normal">Rok realizacji:</label>
            {{ form.year_of_completion|add_class:"border-2 border-black p-2" }}
            {{ form.year_of_completion.errors|add_class:"text-red-500 text-sm" }}
          </div>
        </div>
        <div class="flex flex-col">
          <label for="{{ form.financing_type.id_for_label }}" class="mb-2 font-normal">Rodzaj
            finansowania:</label>
          {{ form.financing_type|add_class:"border-2 border-black p-2" }}
          {{ form.financing_type.errors|add_class:"text-red-500 text-sm" }}
        </div>
        <div id="financing_type_other_container" class="flex flex-col hidden">
          <div class="flex flex-col">
            <label for="{{ form.financing_type_other.id_for_label }}" class="mb-2 font-normal">Inne
              finansowanie:</label>
            {{ form.financing_type_other|add_class:"border-2 border-black p-2" }}
            {{ form.financing_type_other.errors|add_class:"text-red-500 text-sm" }}
          </div>
        </div>
        <div class="flex flex-col">
          <span class="mb-2">Zdjęcia:</span>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

            <div class="flex flex-col">
              {{ form.image1|add_class:"hidden upload-input"|attr:"accept:image/*" }}
              <label for="{{ form.image1.id_for_label }}"
                class="relative flex h-40 w-full items-center justify-center rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer overflow-hidden">
                <div class="placeholder flex items-center gap-2 pointer-events-none">
                  <img src="{% static 'bbi_app/images/button_add.svg' %}" alt="Add" class="w-8 h-8">
                  <div class="flex flex-col leading-tight text-sm">
                    <span>dodaj</span>
                    <span>zdjęcie</span>
                  </div>
                </div>
                <span class="absolute bottom-4 text-xs text-gray-500 pointer-events-none">(zdjęcie główne)</span>
                <img alt="" class="preview hidden absolute inset-0 h-full w-full object-cover rounded-lg" />
              </label>
              {{ form.image1.errors|add_class:"text-red-500 text-sm" }}
            </div>
            <div class="flex flex-col">
              {{ form.image2|add_class:"hidden upload-input"|attr:"accept:image/*" }}
              <label for="{{ form.image2.id_for_label }}"
                class="relative flex h-40 w-full items-center justify-center rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer overflow-hidden">
                <div class="placeholder flex items-center gap-2 pointer-events-none">
                  <img src="{% static 'bbi_app/images/button_add.svg' %}" alt="Add" class="w-8 h-8">
                  <div class="flex flex-col leading-tight text-sm">
                    <span>dodaj</span>
                    <span>zdjęcie</span>
                  </div>
                </div>
                <img alt="" class="preview hidden absolute inset-0 h-full w-full object-cover rounded-lg" />
              </label>
              {{ form.image2.errors|add_class:"text-red-500 text-sm" }}
            </div>
            <div class="flex flex-col">
              {{ form.image3|add_class:"hidden upload-input"|attr:"accept:image/*" }}
              <label for="{{ form.image3.id_for_label }}"
                class="relative flex h-40 w-full items-center justify-center rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer overflow-hidden">
                <div class="placeholder flex items-center gap-2 pointer-events-none">
                  <img src="{% static 'bbi_app/images/button_add.svg' %}" alt="Add" class="w-8 h-8">
                  <div class="flex flex-col leading-tight text-sm">
                    <span>dodaj</span>
                    <span>zdjęcie</span>
                  </div>
                </div>
                <img alt="" class="preview hidden absolute inset-0 h-full w-full object-cover rounded-lg" />
              </label>
              {{ form.image3.errors|add_class:"text-red-500 text-sm" }}
            </div>
            <div class="flex flex-col">
              {{ form.image4|add_class:"hidden upload-input"|attr:"accept:image/*" }}
              <label for="{{ form.image4.id_for_label }}"
                class="relative flex h-40 w-full items-center justify-center rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 cursor-pointer overflow-hidden">
                <div class="placeholder flex items-center gap-2 pointer-events-none">
                  <img src="{% static 'bbi_app/images/button_add.svg' %}" alt="Add" class="w-8 h-8">
                  <div class="flex flex-col leading-tight text-sm">
                    <span>dodaj</span>
                    <span>zdjęcie</span>
                  </div>
                </div>
                <img alt="" class="preview hidden absolute inset-0 h-full w-full object-cover rounded-lg" />
              </label>
              {{ form.image4.errors|add_class:"text-red-500 text-sm" }}
            </div>
          </div>
          <div class="flex flex-col">
            <label for="{{ form.tags.id_for_label }}" class="mt-4 font-normal">Tagi:</label>
            <div class="flex flex-wrap leading-tight">
              {% for checkbox in form.tags %}
              <div class="mr-1">
                <input type="checkbox" id="{{ checkbox.id_for_label }}" name="tags" value="{{ checkbox.data.value }}"
                  class="peer hidden tag-checkbox" {% if checkbox.data.value in form.tags.value %}checked{% endif %}>
                <label for="{{ checkbox.id_for_label }}"
                  class="text-sm text-gray-500 font-normal peer-checked:text-[#21B47E] hover:text-[#21B47E] transition duration-300 leading-tight">
                  #{{ checkbox.choice_label }}
                </label>
              </div>
              {% endfor %}
            </div>
            <p id="tag-counter" class="text-right text-xs text-black mt-2 mb-2">Wybrano <span
                id="selected-count">0</span> z 5 tagów
            </p>
            {{ form.tags.errors|add_class:"text-red-500 text-sm" }}
          </div>
          <label class="mt-4 mb-2 font-normal">Materiały zewnętrzne:</label>
          <p class=" mb-2 text-sm font-extralight">Jeśli w wyniku Waszego działania powstały zewnętrzne materiały
            np. filmowe lub prowadzicie profile w miediach społecznościowych
            poświęcone swojemu działaniu możecie je tutaj zamieścić:</p>

          <div id="link-form-container">
            {{ link_formset.management_form }}
            {% for form in link_formset %}
            <div class="link-form flex items-center gap-2 mb-2">
              {{ form.name|add_class:"border-2 border-black p-2 flex-1 font-light"|attr:"placeholder:nazwa odnośnika" }}
              {{ form.url|add_class:"border-2 border-black p-2 flex-1 font-light"|attr:"placeholder:http://..." }}
            </div>
            {% endfor %}
          </div>
          <button type="button" id="add-link-form" class="mt-2 flex w-full items-center justify-center gap-2 bg-gray-100 p-2">
            <img src="{% static 'bbi_app/images/button_add.svg' %}" alt="Add icon" class="h-5 w-5">
            <span class="font-light">dodaj kolejny odnośnik</span>
          </button>
        </div>
        <div class="flex flex-col">
          <label for="{{ form.contact_info.id_for_label }}" class="mt-4 mb-2 font-normal">Dane
            kontaktowe:</label>
          <p class=" mb-2 text-sm font-extralight">Możecie zostawić dane kontaktowe dla osób, które byłyby
            zainteresowane większą ilością szczegołów dotyczącą Waszego działania.</p>
          {{ form.contact_info|add_class:"border-2 border-black p-2 h-16" }}
          {{ form.contact_info.errors|add_class:"text-red-500 text-sm" }}
          <span class="mt-2 text-right font-extralight text-xs">Maksymalnie 100 znaków</span>
        </div>

        <div class="flex items-center mt-6 mb-2">
          <input type="checkbox" id="accept_terms" name="accept_terms" required
            class="appearance-none w-4 h-4 rounded-full border-2 border-black checked:bg-gray-400 focus:outline-none mr-2">
          <label for="accept_terms" class="text-sm">
            Akceptuję <a href="{% url 'bbi_app:index' %}" class="text-[#21B47E] hover:underline"
              target="_blank">Regulamin Banku Pomysłów</a>
          </label>
        </div>

        <div class="flex justify-end mt-8">
          <button type="submit" class="flex items-center">
            <img src="{% static 'bbi_app/images/button_add.svg' %}" alt="Add" class="w-8 h-8 mr-2">
            <div class="flex flex-col text-left leading-tight">
              <span>dodaj</span>
              <span>pomysł</span>
            </div>
          </button>
        </div>
      </form>
    </div>
  </div>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const addLinkBtn = document.getElementById('add-link-form');
    const container = document.getElementById('link-form-container');
    const totalFormsInput = document.querySelector('input[name="links-TOTAL_FORMS"]');
    const formTemplate = `
      <div class="link-form flex items-center gap-2 mb-2">
        <input type="text" name="links-__prefix__-name" class="border-2 border-black p-2 flex-1" placeholder="Nazwa linku">
        <input type="url" name="links-__prefix__-url" class="border-2 border-black p-2 flex-1" placeholder="https://...">
      </div>
    `;

    addLinkBtn.addEventListener('click', function () {
      let formNum = parseInt(totalFormsInput.value);
      let newForm = formTemplate.replace(/__prefix__/g, formNum);
      container.insertAdjacentHTML('beforeend', newForm);
      totalFormsInput.value = formNum + 1;
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    const financingSelect = document.getElementById('{{ form.financing_type.id_for_label }}');
    const otherContainer = document.getElementById('financing_type_other_container');

    financingSelect.addEventListener('change', function () {
      if (this.value === 'other') {
        otherContainer.classList.remove('hidden');
      } else {
        otherContainer.classList.add('hidden');
      }
    });

    if (financingSelect.value === 'other') {
      otherContainer.classList.remove('hidden');
    } else {
      otherContainer.classList.add('hidden');
    }

    // Podgląd zdjęć dla kafelków
    document.querySelectorAll('input.upload-input').forEach((input) => {
      input.addEventListener('change', () => {
        const label = document.querySelector(`label[for="${input.id}"]`);
        if (!label) return;
        const placeholder = label.querySelector('.placeholder');
        const preview = label.querySelector('img.preview');
        if (input.files && input.files[0]) {
          preview.src = URL.createObjectURL(input.files[0]);
          preview.classList.remove('hidden');
          placeholder.classList.add('hidden');
        } else {
          preview.src = '';
          preview.classList.add('hidden');
          placeholder.classList.remove('hidden');
        }
      });
    });
  });

  // Obsługa licznika tagów
  document.addEventListener('DOMContentLoaded', function () {
    const checkboxes = document.querySelectorAll('.tag-checkbox');
    const counter = document.getElementById('selected-count');
    const MAX_TAGS = 5;

    // Inicjalizacja licznika
    function updateCounter() {
      const checked = document.querySelectorAll('.tag-checkbox:checked').length;
      counter.textContent = checked;

      // Wyłącz niezaznaczone checkboxy, jeśli osiągnięto limit
      if (checked >= MAX_TAGS) {
        checkboxes.forEach(checkbox => {
          if (!checkbox.checked) {
            checkbox.disabled = true;
            checkbox.parentElement.querySelector('label').classList.add('opacity-50', 'cursor-not-allowed');
          }
        });
      } else {
        // Włącz wszystkie checkboxy
        checkboxes.forEach(checkbox => {
          checkbox.disabled = false;
          checkbox.parentElement.querySelector('label').classList.remove('opacity-50', 'cursor-not-allowed');
        });
      }
    }

    // Dodaj nasłuchiwanie zdarzeń do checkboxów
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateCounter);
    });

    // Inicjalizacja stanu na starcie
    updateCounter();
  });

</script>
{% endblock %}